#!/bin/bash

set -euo pipefail

CONFIG_FILE=~/.kube/config.d/kind

function create_cluster() {
    config="
        kind: Cluster
        apiVersion: kind.x-k8s.io/v1alpha4
        nodes:
        - role: control-plane
          kubeadmConfigPatches:
          - |
            kind: InitConfiguration
            nodeRegistration:
              kubeletExtraArgs:
                node-labels: ingress-ready=true
          extraPortMappings:
          - containerPort: 30080
            hostPort: 80
            protocol: TCP
          - containerPort: 30443
            hostPort: 443
            protocol: TCP
          - containerPort: 30000
            hostPort: 30000
            protocol: TCP
        "

    kind create cluster \
        --kubeconfig $CONFIG_FILE \
        --config=<(printf '%s' "$config" | yq .)
}

function install_ingress_nginx() {
    yaml="
        repositories:
          - name: ingress-nginx
            url: https://kubernetes.github.io/ingress-nginx

        releases:
          - name: ingress-nginx
            namespace: ingress-controller
            chart: ingress-nginx/ingress-nginx
            values:
              - controller:
                  allowSnippetAnnotations: true
                  progressDeadlineSeconds: 10
                  config:
                    force-ssl-redirect: true
                  service:
                    type: NodePort
                    nodePorts:
                      http: 30080
                      https: 30443
        "
    yaml_file=$(mktemp)
    printf '%s' "$yaml" | yq . > "$yaml_file"

    export KUBECONFIG="$CONFIG_FILE"
    helmfile apply -f "$yaml_file"
    rm "$yaml_file"
}

create_cluster
install_ingress_nginx
